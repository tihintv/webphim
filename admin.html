<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TiHinTV ‚Äì Admin</title>
  <style>
    :root{--bg:#0f1115;--panel:#171923;--text:#e5e7eb;--muted:#a0aec0;--brand:#3b82f6;--danger:#ef4444;--ok:#10b981}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial}
    header{padding:16px 20px;background:#0b0d12;border-bottom:1px solid #111}
    h1{margin:0;font-size:22px}
    main{max-width:980px;margin:18px auto;padding:0 16px}
    .card{background:var(--panel);border-radius:14px;padding:16px;margin-bottom:16px}
    label{display:block;margin:8px 0 6px;color:#cbd5e1;font-size:14px}
    input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1f2430;background:#11131a;color:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:9px 12px;border:none;border-radius:10px;color:#fff;background:var(--brand);cursor:pointer}
    .btn.secondary{background:#374151}
    .btn.danger{background:var(--danger)}
    .btn.small{padding:5px 8px;font-size:13px;border-radius:8px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid #202532;font-size:14px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#26314a;color:#c7d2fe;font-size:12px}
    .ep-row{display:flex;gap:8px;margin-bottom:8px}
    .hint{color:var(--muted);font-size:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  </style>
</head>
<body>
<header><h1>TiHinTV ‚Äì Admin</h1></header>
<main>
  <div class="card">
    <h2>Th√™m / s·ª≠a phim</h2>
    <div class="row">
      <div>
        <label>T√™n phim</label>
        <input id="title" placeholder="V√≠ d·ª•: Devil May Cry">
      </div>
      <div>
        <label>NƒÉm</label>
        <input id="year" placeholder="2025">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Th·ªÉ lo·∫°i (c√°ch nhau b·∫±ng d·∫•u ph·∫©y)</label>
        <input id="genres" placeholder="Anime, Action">
      </div>
      <div>
        <label>Poster (ƒë∆∞·ªùng d·∫´n)</label>
        <input id="poster" placeholder="posters/abc.jpg">
        <div class="hint">G·ª£i √Ω: up ·∫£nh v√†o th∆∞ m·ª•c <code>posters/</code> trong repo r·ªìi ƒëi·ªÅn ƒë∆∞·ªùng d·∫´n.</div>
      </div>
    </div>

    <label>Video ch√≠nh (YouTube/Drive/mp4‚Ä¶)</label>
    <input id="videoUrl" placeholder="https://...">

    <label>M√¥ t·∫£</label>
    <textarea id="description" rows="3" placeholder="M√¥ t·∫£ phim"></textarea>

    <div style="margin-top:12px">
      <h3>T·∫≠p phim</h3>
      <div id="episodes"></div>
      <button class="btn small" id="btnAddEp">+ Th√™m t·∫≠p</button>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px">
      <button class="btn" id="btnSave">üíæ L∆∞u phim</button>
      <button class="btn secondary" id="btnReset">‚Ü∫ Reset form</button>
    </div>
  </div>

  <div class="card">
    <h2>Danh s√°ch phim</h2>
    <table id="tblMovies">
      <thead>
        <tr><th>T√™n phim</th><th>NƒÉm</th><th>Th·ªÉ lo·∫°i</th><th>Updated</th><th>H√†nh ƒë·ªông</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h2>D·ªØ li·ªáu JSON</h2>
    <div class="hint">Sau khi ch·ªânh s·ª≠a, b·∫•m <b>T·∫£i movies.json</b> ƒë·ªÉ t·∫£i file r·ªìi upload l√™n <code>webphim/movies.json</code> trong GitHub.</div>
    <textarea id="jsonBox" rows="10"></textarea>
    <div style="margin-top:10px"><button id="btnDownload" class="btn">‚¨á T·∫£i movies.json</button></div>
  </div>
</main>

<script>
  const $ = (id)=>document.getElementById(id);
  const titleEl = $('title'), yearEl=$('year'), genresEl=$('genres'), posterEl=$('poster'),
        videoUrlEl=$('videoUrl'), descEl=$('description'), episodesWrap=$('episodes'),
        tblBody = $('tblMovies').querySelector('tbody'), jsonBox=$('jsonBox');

  let movies = [];
  let editingId = null;

  async function loadMovies(){
    try{
      const res = await fetch('movies.json',{cache:'no-store'});
      movies = await res.json();

      // ‚úÖ B√π updatedAt cho d·ªØ li·ªáu c≈© (n·∫øu thi·∫øu)
      movies = (movies||[]).map(m => ({ ...m, updatedAt: m.updatedAt ?? Date.now() }));

      renderTable();
      jsonBox.value = JSON.stringify(movies,null,2);
    }catch(e){
      movies = [];
      renderTable();
      jsonBox.value = '[]';
    }
  }

  function renderTable(){
    tblBody.innerHTML = '';
    movies.forEach(m=>{
      const tr = document.createElement('tr');
      const genres = m.genres ? m.genres.join(', ') : '';
      const updated = m.updatedAt ? new Date(m.updatedAt).toLocaleString() : '-';
      tr.innerHTML = `
        <td>${m.title}</td>
        <td>${m.year ?? ''}</td>
        <td>${genres}</td>
        <td>${updated}</td>
        <td>
          <button class="btn small" onclick="onEdit(${m.id})">S·ª≠a</button>
          <button class="btn small danger" onclick="onDel(${m.id})">Xo√°</button>
        </td>
      `;
      tblBody.appendChild(tr);
    });
  }

  function makeEpisodeRow(ep={name:'T·∫≠p 1',url:''}){
    const wrap = document.createElement('div');
    wrap.className='ep-row';
    wrap.innerHTML = `
      <input class="ep-name" placeholder="T√™n t·∫≠p" value="${ep.name||''}" />
      <input class="ep-url" placeholder="Link t·∫≠p" value="${ep.url||''}" />
      <button class="btn small danger">X</button>
    `;
    wrap.querySelector('button').onclick = ()=> wrap.remove();
    return wrap;
  }

  function resetForm(){
    editingId=null;
    titleEl.value=''; yearEl.value=''; genresEl.value='';
    posterEl.value=''; videoUrlEl.value=''; descEl.value='';
    episodesWrap.innerHTML='';
  }

  $('btnAddEp').onclick = ()=> episodesWrap.appendChild(makeEpisodeRow());
  $('btnReset').onclick = resetForm;

  $('btnSave').onclick = ()=>{
    const title = titleEl.value.trim();
    if(!title){ alert('Nh·∫≠p t√™n phim'); return; }
    const data = {
      id: editingId ?? Date.now(),
      title,
      year: yearEl.value.trim() || '',
      genres: (genresEl.value||'').split(',').map(s=>s.trim()).filter(Boolean),
      poster: posterEl.value.trim(),
      videoUrl: videoUrlEl.value.trim(),
      description: descEl.value.trim(),
      episodes: [...episodesWrap.querySelectorAll('.ep-row')].map((row,i)=>({
        name: row.querySelector('.ep-name').value || `T·∫≠p ${i+1}`,
        url: row.querySelector('.ep-url').value.trim()
      })),
      // lu√¥n c·∫≠p nh·∫≠t timestamp khi l∆∞u/s·ª≠a
      updatedAt: Date.now()
    };
    const idx = movies.findIndex(m=>m.id===data.id);
    if(idx>=0) movies[idx]=data; else movies.push(data);
    renderTable();
    jsonBox.value = JSON.stringify(movies,null,2);
    alert('ƒê√£ l∆∞u v√†o b·ªô nh·ªõ t·∫°m. H√£y b·∫•m "T·∫£i movies.json" v√† upload file l√™n GitHub.');
    resetForm();
  };

  window.onEdit = (id)=>{
    const m = movies.find(x=>x.id===id); if(!m) return;
    editingId = m.id;
    titleEl.value = m.title || '';
    yearEl.value = m.year || '';
    genresEl.value = (m.genres||[]).join(', ');
    posterEl.value = m.poster || '';
    videoUrlEl.value = m.videoUrl || '';
    descEl.value = m.description || '';
    episodesWrap.innerHTML='';
    (m.episodes||[]).forEach(ep=> episodesWrap.appendChild(makeEpisodeRow(ep)));
    window.scrollTo({top:0,behavior:'smooth'});
  };

  window.onDel = (id)=>{
    if(!confirm('Xo√° phim n√†y?')) return;
    movies = movies.filter(m=>m.id!==id);
    renderTable();
    jsonBox.value = JSON.stringify(movies,null,2);
  };

  $('btnDownload').onclick = ()=>{
    const blob = new Blob([jsonBox.value],{type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'movies.json';
    a.click();
    URL.revokeObjectURL(a.href);
  };

  loadMovies();
</script>
</body>
</html>
